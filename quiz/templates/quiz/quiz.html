{% extends "base.html" %}

{% load i18n %}

{% block content %}
<div class="max-w-3xl mx-auto p-4 sm:p-6">
  <div class="relative overflow-hidden rounded-2xl shadow-2xl bg-gradient-to-br from-stone-50 to-stone-100 dark:from-stone-800 dark:to-stone-900 border border-stone-200 dark:border-stone-700">
    <div class="p-6 sm:p-8">
      <div class="flex items-center justify-between mb-6">
        <h1 class="text-xl sm:text-3xl font-serif font-bold text-stone-900 dark:text-white">üêæ {% trans "Uncover the Perfect Breed" %}</h1>
        <span id="step-counter" class="text-xs sm:text-sm text-stone-600 dark:text-stone-300 font-medium"></span>
      </div>

      <!-- Progress Bar -->
      <div class="w-full h-2 bg-stone-200 dark:bg-stone-700 rounded-full mb-6">
        <div id="progress" class="h-2 bg-stone-800 dark:bg-yellow-500 rounded-full transition-all duration-300" style="width: 0%"></div>
      </div>

      <form id="quiz-form" method="post" class="space-y-6">
        {% csrf_token %}

        <!-- Steps -->
        <div id="steps" class="space-y-10">
          {% for field in form %}
          <div class="quiz-step {% if not forloop.first %}hidden{% endif %}">
            <label class="block text-lg sm:text-2xl font-serif font-bold text-stone-900 dark:text-white mb-4">{{ field.label }}</label>
            <div class="space-y-2 quiz-group">
              {{ field }}
              {% if field.help_text %}
                <p class="text-sm text-stone-500">{{ field.help_text }}</p>
              {% endif %}
              {% if field.errors %}
                <p class="text-sm text-red-600">{{ field.errors|striptags }}</p>
              {% endif %}
            </div>
          </div>
          {% endfor %}
        </div>

        <!-- Navigation Buttons -->
        <div class="flex items-center justify-between pt-4">
          <button id="prev" type="button" class="inline-flex items-center px-5 py-2 rounded-lg border border-stone-300 dark:border-stone-600 text-stone-800 dark:text-stone-100 hover:bg-stone-100 dark:hover:bg-stone-700 disabled:opacity-40 disabled:cursor-not-allowed transition-all">
            {% include "icons/arrow_left.html" %}
            <span class="ml-2">{% trans "Previous" %}</span>
          </button>

          <div class="flex items-center gap-3">
            <button id="next" type="button" class="px-6 py-2 rounded-lg bg-gradient-to-r from-stone-700 to-stone-800 text-white hover:from-stone-800 hover:to-stone-900 shadow-md transition-all">
              {% trans "Next" %}
            </button>
            <button id="submit" type="submit" class="hidden px-6 py-2 rounded-lg bg-gradient-to-r from-yellow-600 to-yellow-700 text-white hover:from-yellow-700 hover:to-yellow-800 shadow-md transition-all">
              {% trans "Get Result" %}
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ block.super }}
<script>
  (function() {
    const steps = Array.from(document.querySelectorAll('.quiz-step'));
    const prevBtn = document.getElementById('prev');
    const nextBtn = document.getElementById('next');
    const submitBtn = document.getElementById('submit');
    const progress = document.getElementById('progress');
    const counter = document.getElementById('step-counter');
    const form = document.getElementById('quiz-form');

    let current = 0;

    function updateUI() {
      steps.forEach((s, i) => s.classList.toggle('hidden', i !== current));
      prevBtn.disabled = current === 0;
      const pct = Math.round(((current + 1) / steps.length) * 100);
      progress.style.width = pct + '%';
      counter.textContent = `Step ${current + 1} of ${steps.length}`;
      // Toggle submit vs next
      const isLast = current === steps.length - 1;
      nextBtn.classList.toggle('hidden', isLast);
      submitBtn.classList.toggle('hidden', !isLast);
    }

    function validateCurrent() {
      // Ensure a radio is selected for current step
      const radios = steps[current].querySelectorAll('input[type="radio"]');
      if (radios.length === 0) return true;
      return Array.from(radios).some(r => r.checked);
    }

    nextBtn.addEventListener('click', () => {
      if (!validateCurrent()) {
        // Simple nudge
        steps[current].classList.add('ring-2','ring-red-400','rounded-lg');
        setTimeout(() => steps[current].classList.remove('ring-2','ring-red-400','rounded-lg'), 800);
        return;
      }
      if (current < steps.length - 1) {
        current += 1;
        updateUI();
      }
    });

    prevBtn.addEventListener('click', () => {
      if (current > 0) {
        current -= 1;
        updateUI();
      }
    });

    form.addEventListener('submit', (e) => {
      if (!validateCurrent()) {
        e.preventDefault();
        steps[current].classList.add('ring-2','ring-red-400','rounded-lg');
        setTimeout(() => steps[current].classList.remove('ring-2','ring-red-400','rounded-lg'), 800);
      }
    });

    updateUI();
  })();
</script>
<script>
  // Style Django RadioSelect as selectable cards
  (function() {
    const groups = document.querySelectorAll('.quiz-group');
    groups.forEach(g => {
      // Wrap <ul> if present and style items
      const uls = g.querySelectorAll('ul');
      uls.forEach(ul => {
        ul.classList.add('space-y-3');
        ul.querySelectorAll('li').forEach(li => {
          const label = li.querySelector('label');
          const input = li.querySelector('input[type="radio"]');
          if (label && input) {
            label.classList.add('flex','items-center','justify-between','w-full','px-4','py-3','rounded-lg','border','border-stone-300','dark:border-stone-600','bg-white','dark:bg-stone-800','hover:border-stone-400','dark:hover:border-stone-500','cursor-pointer','transition-all','duration-200','shadow-sm','hover:shadow-md');
            input.classList.add('hidden'); // Hide the default radio button
            
            // Create a custom radio button
            const customRadio = document.createElement('span');
            customRadio.classList.add('w-5', 'h-5', 'border-2', 'border-stone-400', 'dark:border-stone-500', 'rounded-full', 'flex-shrink-0', 'mr-4', 'transition-all', 'duration-200');
            label.prepend(customRadio);
          }
        });
      });
    });
  })();
</script>
<style>
  /* Highlight selected option using :has for modern browsers */
  .quiz-group li label:has(input[type="radio"]:checked) {
    background: linear-gradient(to right, rgb(28 25 23), rgb(41 37 36));
    color: #fff;
    border-color: rgb(41 37 36);
  }
  .dark .quiz-group li label:has(input[type="radio"]:checked) {
    background: linear-gradient(to right, rgb(82 82 91), rgb(24 24 27));
    color: #f9fafb;
    border-color: rgb(82 82 91);
  }
  /* Style the custom radio button when checked */
  .quiz-group li label:has(input[type="radio"]:checked) span:first-child {
    background-color: #facc15; /* yellow-400 */
    border-color: #facc15;
  }
</style>
{% endblock %}
